# 4 å¤šå±‚æ„ŸçŸ¥æœº

## 4.2 å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°

ç†è®ºéƒ¨åˆ†å¯ä»¥å‚è€ƒå…¶ä»–ä¹¦ç›®ï¼Œå¦‚ï¼š

> ã€Šç»Ÿè®¡å­¦ä¹ æ–¹æ³•ã€‹ æèˆª  
> ã€Šæœ€ä¼˜åŒ–ï¼šå»ºæ¨¡ã€ç®—æ³•ä¸ç†è®ºã€‹ åˆ˜æµ©æ´‹ã€æˆ·å°†ã€æå‹‡é”‹ã€æ–‡å†æ–‡  
> ã€Šæœºå™¨å­¦ä¹ ã€‹ å‘¨å¿—å

> 4.1.1.3. ä»çº¿æ€§åˆ°éçº¿æ€§  
> æ³¨æ„åœ¨æ·»åŠ éšè—å±‚ä¹‹åï¼Œæ¨¡å‹ç°åœ¨éœ€è¦è·Ÿè¸ªå’Œæ›´æ–°é¢å¤–çš„å‚æ•°ã€‚ å¯æˆ‘ä»¬èƒ½ä»ä¸­å¾—åˆ°ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ ä½ å¯èƒ½ä¼šæƒŠè®¶åœ°å‘ç°ï¼šåœ¨ä¸Šé¢å®šä¹‰çš„æ¨¡å‹é‡Œï¼Œæˆ‘ä»¬æ²¡æœ‰å¥½å¤„ï¼ åŸå› å¾ˆç®€å•ï¼šä¸Šé¢çš„éšè—å•å…ƒç”±è¾“å…¥çš„ä»¿å°„å‡½æ•°ç»™å‡ºï¼Œ è€Œè¾“å‡ºï¼ˆsoftmaxæ“ä½œå‰ï¼‰åªæ˜¯éšè—å•å…ƒçš„ä»¿å°„å‡½æ•°ã€‚ ä»¿å°„å‡½æ•°çš„ä»¿å°„å‡½æ•°æœ¬èº«å°±æ˜¯ä»¿å°„å‡½æ•°ï¼Œ ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰çš„çº¿æ€§æ¨¡å‹å·²ç»èƒ½å¤Ÿè¡¨ç¤ºä»»ä½•ä»¿å°„å‡½æ•°ã€‚

è¦æ³¨æ„æ¿€æ´»å‡½æ•°Ïƒ(â‹…)åœ¨å¤šå±‚ç½‘ç»œ(å¤šå±‚æ„ŸçŸ¥æœº)ä¸­çš„ä½œç”¨ï¼Œè€Œè¿™æ ·çš„æ¿€æ´»å‡½æ•°Ïƒéœ€è¦æ˜¯éçº¿æ€§å‡½æ•°ã€‚æœ€ç®€å•çš„ReLU(Rectified linear unit)å‡½æ•°å°±æ˜¯åœ¨çº¿æ€§å‡½æ•°ä¸Šä¿®æ”¹çš„æ¥çš„ï¼Œä¸”å…¼é¡¾äº†è¿ç®—å¤æ‚åº¦ã€‚

> ä½¿ç”¨ReLUçš„åŸå› æ˜¯ï¼Œå®ƒæ±‚å¯¼è¡¨ç°å¾—ç‰¹åˆ«å¥½ï¼šè¦ä¹ˆè®©å‚æ•°æ¶ˆå¤±ï¼Œè¦ä¹ˆè®©å‚æ•°é€šè¿‡ã€‚ è¿™ä½¿å¾—ä¼˜åŒ–è¡¨ç°çš„æ›´å¥½ï¼Œå¹¶ä¸”ReLUå‡è½»äº†å›°æ‰°ä»¥å¾€ç¥ç»ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼ˆç¨åå°†è¯¦ç»†ä»‹ç»ï¼‰ã€‚

åœ¨è¿™ä¸€èŠ‚çš„ä¸­æ–‡ç½‘é¡µä¸­æœ‰å‡ å¤„é”™è¯¯ï¼š[4.2. å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°](https://zh-v2.d2l.ai/chapter_multilayer-perceptrons/mlp-scratch.html)ï¼Œå…·ä½“è¡¨ç°ä¸ºè®­ç»ƒç”»å‡ºçš„å›¾ä¸­çœ‹ä¸åˆ°train lossæ›²çº¿

1. d2låŒ…ä¸­å°è£…çš„``train_epoch_ch3``å‡½æ•°å‡ºç°é”™è¯¯(åœ¨[3.6. softmaxå›å½’çš„ä»é›¶å¼€å§‹å®ç°](https://zh-v2.d2l.ai/chapter_linear-networks/softmax-regression-scratch.html)ä¸­ç¼–å†™)ã€‚åœ¨GitHubä¸­æ–‡ç‰ˆçš„[d2l-zh/d2l/torch.py](https://github.com/d2l-ai/d2l-zh/blob/master/d2l/torch.py)çš„å‡½æ•°èƒ½æ­£ç¡®è¿è¡Œã€‚
   
   - å¯ä»¥ç›´æ¥ä¿®æ”¹``\home\u\miniconda3\lib\python3.9\site-packages\d2l\torch.py``ä¸­çš„``train_epoch_ch3``å‡½æ•°ä¸º
     
     ```python
     def train_epoch_ch3(net, train_iter, loss, updater):
     """è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰
     Defined in :numref:`sec_softmax_scratch`"""
     # å°†æ¨¡å‹è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼
     if isinstance(net, torch.nn.Module):
       net.train()
     # è®­ç»ƒæŸå¤±æ€»å’Œã€è®­ç»ƒå‡†ç¡®åº¦æ€»å’Œã€æ ·æœ¬æ•°
     metric = Accumulator(3)
     for X, y in train_iter:
       # è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°å‚æ•°
       y_hat = net(X)
       l = loss(y_hat, y)
       if isinstance(updater, torch.optim.Optimizer):
           # ä½¿ç”¨PyTorchå†…ç½®çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°
           updater.zero_grad()
           l.mean().backward()
           updater.step()
       else:
           # ä½¿ç”¨å®šåˆ¶çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°
           l.sum().backward()
           updater(X.shape[0])
       metric.add(float(l.sum()), accuracy(y_hat, y), y.numel())
     # è¿”å›è®­ç»ƒæŸå¤±å’Œè®­ç»ƒç²¾åº¦
     return metric[0] / metric[2], metric[1] / metric[2]
     ```
     
     <font color=#FF000>å…·ä½“å°±æ˜¯ifè¯­å¥ä¸­ç¬¬ä¸€ä¸ªåå‘ä¼ æ’­é”™å†™ä¸ºäº†</font> `l.sum().backward()`

2. æŸå¤±å‡½æ•°å‡ºé”™ï¼ŒGitHubä¸­æ–‡ç‰ˆ[å¤šå±‚æ„ŸçŸ¥æœºçš„ä»é›¶å¼€å§‹å®ç°](https://github.com/d2l-ai/d2l-zh/blob/master/chapter_multilayer-perceptrons/mlp-scratch.md)ä¸­æœ‰é¢å¤–çš„reductionå‚æ•° `loss = nn.CrossEntropyLoss(reduction='none')`

æ­£å¸¸æ¥è®²å¦‚æœæ˜¯ç”¨`pip install d2l-zh`å°±ä¸ä¼šå‡ºé—®é¢˜çš„ï¼Œæ­£åœ¨çº ç»“æ˜¯ä¸æ˜¯è¦é‡æ–°æQAQ

## 4.3 å¤šå±‚æ„ŸçŸ¥æœºçš„ç®€æ´å®ç°

æŸå¤±å‡½æ•°åŒæ ·å‡ºé”™äº†ã€‚

```python
def init_weights(m):
    if type(m) == nn.Linear:
        nn.init.normal_(m.weight, std=0.01)
```

åœ¨æ­å»ºå¥½ç½‘ç»œæ¨¡å‹ä¹‹åï¼Œä¸€ä¸ªé‡è¦çš„æ­¥éª¤å°±æ˜¯å¯¹ç½‘ç»œæ¨¡å‹ä¸­çš„æƒå€¼è¿›è¡Œåˆå§‹åŒ–ã€‚é€‚å½“çš„æƒå€¼åˆå§‹åŒ–å¯ä»¥åŠ å¿«æ¨¡å‹çš„æ”¶æ•›ï¼Œè€Œä¸æ°å½“çš„æƒå€¼åˆå§‹åŒ–å¯èƒ½å¼•å‘æ¢¯åº¦æ¶ˆå¤±æˆ–è€…æ¢¯åº¦çˆ†ç‚¸ï¼Œæœ€ç»ˆå¯¼è‡´æ¨¡å‹æ— æ³•æ”¶æ•›ã€‚

åœ¨è¿™é‡Œï¼Œ`std=0.01`æ”¹ä¸º0.1èƒ½æ›´å¿«åœ°æ”¶æ•›ã€‚

å¤šåŠ ä¸€å±‚ï¼Œèƒ½å¤Ÿç¨å¾®æé«˜ä¸€äº›å‡†ç¡®ç‡ï¼Œä½†è¿˜ä¸å¦‚æé«˜`num_epochs`ã€‚  
åœ¨æ¿€æ´»å‡½æ•°ä¸­ï¼Œ`nn.ReLU()`èƒ½æ¯”`nn.Sigmoid()`æ›´å¿«çš„æ”¶æ•›ï¼Œä½†ä½¿ç”¨`nn.Sigmoid()`æ—¶ï¼Œ`train loss`ä¸`test loss`è´´åˆçš„è¦å¥½å¾ˆå¤šã€‚

```python
net = nn.Sequential(nn.Flatten(),
                    nn.Linear(784, 256),
                    nn.ReLU(),
                    nn.Linear(256, 20),
                    nn.ReLU(),
                    nn.Linear(20, 10))
```

## 4.4 æ¨¡å‹é€‰æ‹©ã€æ¬ æ‹Ÿåˆå’Œè¿‡æ‹Ÿåˆ

ä¼°è®¡æ¨¡å‹å®¹é‡  
æ¨¡å‹å®¹é‡ä¸»è¦ç”±**å‚æ•°çš„ä¸ªæ•°**ä¸**å‚æ•°å€¼çš„é€‰æ‹©èŒƒå›´**å½±å“

![capacity-vs-error](images/capacity-vs-error.png)

## 4.5 æƒé‡è¡°é€€

[l1 ç›¸æ¯”äº l2 ä¸ºä»€ä¹ˆå®¹æ˜“è·å¾—ç¨€ç–è§£ï¼Ÿ](https://www.zhihu.com/question/37096933/answer/70938890)  
[l1 ç›¸æ¯”äº l2 ä¸ºä»€ä¹ˆå®¹æ˜“è·å¾—ç¨€ç–è§£ï¼Ÿ](https://www.zhihu.com/question/37096933/answer/475278057)  
[ç¨€ç–è¡¨è¾¾çš„æ„ä¹‰åœ¨äºï¼Ÿä¸ºä»€ä¹ˆç¨€ç–è¡¨è¾¾å¾—åˆ°å¹¿æ³›çš„åº”ç”¨ï¼Ÿ](https://www.zhihu.com/question/26602796/answer/33425052)  
[20 ï¼ˆç†è®º+ä»£ç ï¼‰ç†è§£æ¨¡å‹æ­£åˆ™åŒ–ï¼šL1æ­£åˆ™ã€L2æ­£åˆ™](https://zhuanlan.zhihu.com/p/113373391)

> l2æ˜¯æ¯æ¬¡ä¹˜ä¸Šä¸€ä¸ªå°äº1çš„å€æ•°è¿›è¡Œæ”¶æ•›ï¼Œè€Œl1æ˜¯æ¯æ¬¡å‡å»ä¸€ä¸ªå¸¸æ•°çš„çº¿æ€§æ”¶æ•›ã€‚æ‰€ä»¥l1æ›´å®¹æ˜“æ”¶æ•›åˆ°0è€Œ l2åªèƒ½æ”¶æ•›åˆ°æ¯”è¾ƒå°çš„å€¼ã€‚

> æ­¤å¤–ï¼Œä½ å¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆæˆ‘ä»¬é¦–å…ˆä½¿ç”¨L2èŒƒæ•°ï¼Œè€Œä¸æ˜¯L1èŒƒæ•°ã€‚ äº‹å®ä¸Šï¼Œè¿™ä¸ªé€‰æ‹©åœ¨æ•´ä¸ªç»Ÿè®¡é¢†åŸŸä¸­éƒ½æ˜¯æœ‰æ•ˆçš„å’Œå—æ¬¢è¿çš„ã€‚ L2æ­£åˆ™åŒ–çº¿æ€§æ¨¡å‹æ„æˆç»å…¸çš„*å²­å›å½’*ï¼ˆridge regressionï¼‰ç®—æ³•ï¼Œ L1æ­£åˆ™åŒ–çº¿æ€§å›å½’æ˜¯ç»Ÿè®¡å­¦ä¸­ç±»ä¼¼çš„åŸºæœ¬æ¨¡å‹ï¼Œ é€šå¸¸è¢«ç§°ä¸º*å¥—ç´¢å›å½’*ï¼ˆlasso regressionï¼‰ã€‚ ä½¿ç”¨L2èŒƒæ•°çš„ä¸€ä¸ªåŸå› æ˜¯å®ƒå¯¹æƒé‡å‘é‡çš„å¤§åˆ†é‡æ–½åŠ äº†å·¨å¤§çš„æƒ©ç½šã€‚ è¿™ä½¿å¾—æˆ‘ä»¬çš„å­¦ä¹ ç®—æ³•åå‘äºåœ¨å¤§é‡ç‰¹å¾ä¸Šå‡åŒ€åˆ†å¸ƒæƒé‡çš„æ¨¡å‹ã€‚ åœ¨å®è·µä¸­ï¼Œè¿™å¯èƒ½ä½¿å®ƒä»¬å¯¹å•ä¸ªå˜é‡ä¸­çš„è§‚æµ‹è¯¯å·®æ›´ä¸ºç¨³å®šã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒL1æƒ©ç½šä¼šå¯¼è‡´æ¨¡å‹å°†æƒé‡é›†ä¸­åœ¨ä¸€å°éƒ¨åˆ†ç‰¹å¾ä¸Šï¼Œ è€Œå°†å…¶ä»–æƒé‡æ¸…é™¤ä¸ºé›¶ã€‚ è¿™ç§°ä¸º*ç‰¹å¾é€‰æ‹©*ï¼ˆfeature selectionï¼‰ï¼Œè¿™å¯èƒ½æ˜¯å…¶ä»–åœºæ™¯ä¸‹éœ€è¦çš„ã€‚

## 4.6 æš‚é€€æ³•ï¼ˆDropoutï¼‰

![dropout](./images/dropout2.png)

> Dropoutåˆå¯è¢«ç¿»è¯‘ä¸ºä¸¢å¼ƒæ³•ã€‚

åœ¨åˆšè¢«æå‡ºæ—¶ï¼Œè®ºæ–‡ä½œè€…æƒ³æ³•æ˜¯å°†å³ç½‘ç»œå½“ä½œå·¦ç½‘ç»œçš„å­ç½‘ç»œï¼Œé€šè¿‡dropoutå¹³å‡å„ä¸ªå­ç½‘ç»œå¾—åˆ°æ›´å¥½çš„æ•ˆæœï¼Œè€Œç°åœ¨ä¸»æµçœ‹æ³•æ˜¯å°†dropoutå½“ä½œä¸€ä¸ªæ­£åˆ™é¡¹ã€‚

å…³äºåœ¨æœ¬èŠ‚å®šä¹‰æ¨¡å‹çš„æ–¹æ³•ï¼Œå¯æŸ¥é˜…`pytorch-tutorial`ä»¥åŠå¦‚ä¸‹æ–‡ç« 
> [åœ¨PyTorchä¸­åˆ›å»ºç¥ç»ç½‘ç»œï¼ˆé€å¥è§£é‡Šä»£ç ï¼‰](https://zhuanlan.zhihu.com/p/350512361)  
> [è¯¦è§£Pytorchä¸­çš„ç½‘ç»œæ„é€ ](https://zhuanlan.zhihu.com/p/53927068)  
> [pytorchæ•™ç¨‹ä¹‹nn.Moduleç±»è¯¦è§£â€”â€”ä½¿ç”¨Moduleç±»æ¥è‡ªå®šä¹‰æ¨¡å‹](https://blog.csdn.net/qq_27825451/article/details/90550890)

ç½‘ç»œæ¡†æ¶ï¼ˆskeletonï¼‰å»ºç«‹å®Œæˆä¹‹åï¼Œå¯ä»¥é€šè¿‡æ‰“å°ç½‘ç»œæ£€æŸ¥ã€‚

``` python
print(net)
print('+-'*40)
for name, parameters in net.named_parameters():
    print(name, ':', parameters.size())
```

```
Net(
  (lin1): Linear(in_features=784, out_features=256, bias=True)
  (lin2): Linear(in_features=256, out_features=256, bias=True)
  (lin3): Linear(in_features=256, out_features=10, bias=True)
  (relu): ReLU()
)
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
lin1.weight : torch.Size([256, 784])
lin1.bias : torch.Size([256])
lin2.weight : torch.Size([256, 256])
lin2.bias : torch.Size([256])
lin3.weight : torch.Size([10, 256])
lin3.bias : torch.Size([10])
```

-------------------------------------------------------------

æˆ‘è§‰å¾—æœ‰å¿…è¦ç»™æ–‡ç« ç•™ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå°±ä»è¿™ç¯‡å¼€å§‹å§ã€‚

å¯ä»¥åˆ©ç”¨markdownè¡¨æ ¼è¯­æ³•æ¥å®ç°æ—¶é—´æˆ³å³å¯¹é½ã€‚

``` markdown
| Syntax      | Description | Test Text     |
| :---        |    :----:   |          ---: |
| Header      | Title       | Here's this   |
| Paragraph   | Text        | And more      |
```

| Syntax      | Description | Test Text     |
| :---        |    :----:   |          ---: |
| Header      | Title       | Here's this   |
| Paragraph   | Text        | And more      |

``` markdown
|2022å¹´3æœˆ5æ—¥|
|---:|
```

|2022å¹´3æœˆ5æ—¥|
|---:|

## 4.7 å‰å‘ä¼ æ’­ã€åå‘ä¼ æ’­å’Œè®¡ç®—å›¾

æœºå™¨å­¦ä¹ çš„ç†è®ºçŸ¥è¯†éƒ¨åˆ†ï¼Œå·²ç»åœ¨ 2.5 è‡ªåŠ¨å¾®åˆ† è®²è¿‡ä¸€éƒ¨åˆ†äº†ã€‚  
åœ¨ç›´æ’­è¯¾ç¨‹ä¸­4.7å’Œ4.8æ˜¯åˆä¸º1èŠ‚çš„ã€‚

## 4.8 æ•°å€¼ç¨³å®šæ€§å’Œæ¨¡å‹åˆå§‹åŒ–

åœ¨é€šè¿‡é“¾å¼æ³•åˆ™è®¡ç®—æ¢¯åº¦æ—¶ï¼š

> æˆ‘ä»¬å®¹æ˜“å—åˆ°æ•°å€¼ä¸‹æº¢é—®é¢˜çš„å½±å“. å½“å°†å¤ªå¤šçš„æ¦‚ç‡ä¹˜åœ¨ä¸€èµ·æ—¶ï¼Œè¿™äº›é—®é¢˜ç»å¸¸ä¼šå‡ºç°ã€‚ åœ¨å¤„ç†æ¦‚ç‡æ—¶ï¼Œä¸€ä¸ªå¸¸è§çš„æŠ€å·§æ˜¯åˆ‡æ¢åˆ°å¯¹æ•°ç©ºé—´ï¼Œ å³å°†æ•°å€¼è¡¨ç¤ºçš„å‹åŠ›ä»å°¾æ•°è½¬ç§»åˆ°æŒ‡æ•°ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œä¸Šé¢çš„é—®é¢˜æ›´ä¸ºä¸¥é‡ï¼š æœ€åˆï¼ŒçŸ©é˜µ  ğŒ(ğ‘™)  å¯èƒ½å…·æœ‰å„ç§å„æ ·çš„ç‰¹å¾å€¼ã€‚ ä»–ä»¬å¯èƒ½å¾ˆå°ï¼Œä¹Ÿå¯èƒ½å¾ˆå¤§ï¼› ä»–ä»¬çš„ä¹˜ç§¯å¯èƒ½éå¸¸å¤§ï¼Œä¹Ÿå¯èƒ½éå¸¸å°ã€‚
ä¸ç¨³å®šæ¢¯åº¦å¸¦æ¥çš„é£é™©ä¸æ­¢åœ¨äºæ•°å€¼è¡¨ç¤ºï¼› ä¸ç¨³å®šæ¢¯åº¦ä¹Ÿå¨èƒåˆ°æˆ‘ä»¬ä¼˜åŒ–ç®—æ³•çš„ç¨³å®šæ€§ã€‚ æˆ‘ä»¬å¯èƒ½é¢ä¸´ä¸€äº›é—®é¢˜ã€‚ è¦ä¹ˆæ˜¯æ¢¯åº¦çˆ†ç‚¸ï¼ˆgradient explodingï¼‰é—®é¢˜ï¼š å‚æ•°æ›´æ–°è¿‡å¤§ï¼Œç ´åäº†æ¨¡å‹çš„ç¨³å®šæ”¶æ•›ï¼› è¦ä¹ˆæ˜¯æ¢¯åº¦æ¶ˆå¤±ï¼ˆgradient vanishingï¼‰é—®é¢˜ï¼š å‚æ•°æ›´æ–°è¿‡å°ï¼Œåœ¨æ¯æ¬¡æ›´æ–°æ—¶å‡ ä¹ä¸ä¼šç§»åŠ¨ï¼Œå¯¼è‡´æ¨¡å‹æ— æ³•å­¦ä¹ ã€‚

[çŸ©é˜µæ±‚å¯¼çš„æœ¬è´¨ä¸åˆ†å­å¸ƒå±€ã€åˆ†æ¯å¸ƒå±€çš„æœ¬è´¨ï¼ˆçŸ©é˜µæ±‚å¯¼â€”â€”æœ¬è´¨ç¯‡ï¼‰](https://zhuanlan.zhihu.com/p/263777564)

å¦‚æœèƒ½å°†æ¯ä¸€å±‚çš„weightå½“ä½œâ€œéšæœºå˜é‡â€ï¼Œå°†å…¶æ–¹å·®å›ºå®šåœ¨ä¸€ä¸ªå¸¸æ•°ä¼šæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚

> å¦‚æœä¸ç¡®ä¿æ¿€æ´»å€¼çš„æ–¹å·®ä¸€è‡´,æ¿€æ´»å€¼ä¼šä¸€ç›´éœ‡è¡(æ¯”å¦‚,æ–¹å·®ä¸€ç›´å˜å¤§æˆ–è€…å˜å°),å¯¼è‡´ç½‘ç»œé™¤äº†è¦æ‹Ÿåˆç‰¹å¾çš„å€¼,è¿˜è¦æ‹Ÿåˆæ•°æ®æœ¬èº«çš„åˆ†å¸ƒ,å¢å¤§ç½‘ç»œçš„å­¦ä¹ å›°éš¾.

|2022å¹´3æœˆ6æ—¥|
|---:|
